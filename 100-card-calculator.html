<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>100-Card Deck Probability Explorer</title>

  <!-- Chart.js pinned version -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <style>
    :root {
      --color-primary: rgb(99, 102, 241);
      --color-secondary: rgb(236, 72, 153);
      --color-success: rgb(16, 185, 129);
      --color-text: #1f2937;
      --color-muted: #6b7280;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      margin: 0;
      min-height: 100vh;
      padding: 2rem;
      color: var(--color-text);
    }
    .panel {
      background: white;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
      display: grid;
      grid-template-columns: 240px 1fr;
      grid-template-rows: auto 1fr auto;
      gap: 1.5rem;
    }
    .panel > header {
      grid-column: 1 / -1;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 1rem;
    }
    .panel > header h2 {
      margin: 0 0 0.25rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .panel > header p {
      margin: 0;
      color: var(--color-muted);
    }
    .instructions {
      grid-column: 1 / -1;
      background: #f8fafc;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      font-size: 0.9rem;
      line-height: 1.6;
      color: var(--color-muted);
    }
    .instructions strong {
      color: var(--color-text);
    }
    .instructions ul {
      margin: 0.5rem 0 0 0;
      padding-left: 1.25rem;
    }
    .instructions li {
      margin: 0.25rem 0;
    }
    .instructions code {
      background: #e5e7eb;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85em;
    }
    .controls {
      display: flex;
      flex-direction: column;
      background: #fafafa;
      padding: 1.25rem;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .controls label:first-child {
      margin-top: 0;
    }
    .chart-container {
      min-height: 400px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 1.2rem;
      font-size: 0.9rem;
      color: var(--color-text);
    }
    input[type="range"] {
      width: 100%;
      margin-top: 0.5rem;
      accent-color: var(--color-primary);
    }
    .value-box {
      font-weight: 700;
      color: var(--color-primary);
    }
    .stat-box {
      margin-top: 1.5rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      text-align: center;
    }
    .stat-box b {
      display: block;
      font-size: 0.8rem;
      color: var(--color-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-success);
    }
    .legend {
      margin-top: 1rem;
      font-size: 0.8rem;
      color: var(--color-muted);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.4rem 0;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }
    .legend-color.bar {
      background: var(--color-secondary);
      opacity: 0.4;
      border: 1px solid var(--color-secondary);
    }
    .legend-color.line {
      background: var(--color-success);
    }
  </style>
</head>

<body>
  <div class="panel">
    <header>
      <h2>100-Card Deck Probability Explorer</h2>
      <p>Hypergeometric calculator for MTG Commander deck theorycrafting</p>
    </header>

    <div class="controls">
      <label for="sliderK">Target Cards</label>
      <input id="sliderK" type="range" min="1" max="99" value="35" />
      <span><span id="valK" class="value-box">35</span> / 100</span>

      <label for="sliderExtra">Extra Draws</label>
      <input id="sliderExtra" type="range" min="0" max="10" value="1" />
      <span id="valExtra" class="value-box">1</span>

      <div class="stat-box">
        <b>P(at least one target)</b>
        <span id="atLeastOne" class="stat-value">–</span>
      </div>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-color line"></span>
          <span>Cumulative (at least k)</span>
        </div>
        <div class="legend-item">
          <span class="legend-color bar"></span>
          <span>Exact (exactly k)</span>
        </div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>

    <div class="instructions">
      <strong>How to use:</strong>
      <ul>
        <li><strong>Target Cards</strong> — 
          How many cards match the desired category (e.g., lands, creatures, "the card you want to draw").</li>

        <li><strong>Extra Draws</strong> — 
          Cards drawn beyond your opening hand. This should be 1 on turn 1, since you draw your 8th card.</li>
      </ul>
      <p>The <span style="color: var(--color-success); font-weight: 600;">green line</span> calculates the probability of "at least this many" target cards. 
      For example, if you're getting mana screwed, you should make sure the green line shows 95% or higher for 1 card. That means you have a 95% chance of getting at least 1 land. Try adjusting the sliders to check if you'll have a 50% chance of 4 lands on turn 4, if that's the ramp your deck needs.</p>
      
      <p>The <span style="color: var(--color-secondary); font-weight: 600;">pink bars</span> histogram the probability of drawing "exactly this many" target cards. 
        I find this useful for imagining my hand's composition. The "peak" is the most likely number of target cards I'll be holding.</p>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      // Register datalabels plugin
      Chart.register(ChartDataLabels);

      // ---------- Constants ----------
      const DECK_SIZE = 100;
      const OPENING_HAND = 7;
      const MAX_EXTRA_DRAWS = 10;

      // ---------- DOM Elements ----------
      const elements = {
        sliderK: document.getElementById("sliderK"),
        sliderExtra: document.getElementById("sliderExtra"),
        valK: document.getElementById("valK"),
        valExtra: document.getElementById("valExtra"),
        atLeastOne: document.getElementById("atLeastOne"),
        ctx: document.getElementById("chart").getContext("2d"),
      };

      // ---------- Chart Instance ----------
      let chart = null;

      // ---------- Combinatorics ----------
      /**
       * Compute binomial coefficient C(n, k) using multiplicative formula.
       * Avoids factorial overflow for reasonable n.
       * @param {number} n - Total items
       * @param {number} k - Items to choose
       * @returns {number} C(n, k)
       */
      function binomial(n, k) {
        if (k < 0 || k > n) return 0;
        if (k === 0 || k === n) return 1;
        // Optimize by using smaller k
        if (k > n - k) k = n - k;
        let result = 1;
        for (let i = 0; i < k; i++) {
          result = (result * (n - i)) / (i + 1);
        }
        return result;
      }

      /**
       * Hypergeometric PMF: P(X = k)
       * Drawing n items from population N containing K successes.
       * @param {number} N - Population size
       * @param {number} K - Number of success states in population
       * @param {number} n - Number of draws
       * @param {number} k - Number of observed successes
       * @returns {number} Probability
       */
      function hypergeometricPmf(N, K, n, k) {
        return (binomial(K, k) * binomial(N - K, n - k)) / binomial(N, n);
      }

      /**
       * Compute P(X >= 1) for hypergeometric distribution.
       * @param {number} N - Population size
       * @param {number} K - Number of success states
       * @param {number} n - Number of draws
       * @returns {number} P(X >= 1) = 1 - P(X = 0)
       */
      function hypergeometricAtLeastOne(N, K, n) {
        return 1 - hypergeometricPmf(N, K, n, 0);
      }

      // ---------- Chart Configuration ----------
      const chartColors = {
        primary: "rgb(99, 102, 241)",
        primaryAlpha: "rgba(99, 102, 241, 0.18)",
        secondary: "rgb(236, 72, 153)",
        secondaryAlpha: "rgba(236, 72, 153, 0.18)",
        success: "rgb(16, 185, 129)",
        successAlpha: "rgba(16, 185, 129, 0.18)",
      };

      const percentTickCallback = (value) => `${(value * 100).toFixed(1)}%`;

      // ---------- UI Update ----------
      function updateUI() {
        const K = Number.parseInt(elements.sliderK.value, 10);
        const extra = Number.parseInt(elements.sliderExtra.value, 10);

        elements.valK.textContent = K;
        elements.valExtra.textContent = extra;

        updateCharts(K, extra);
      }

      function updateCharts(K, extra) {
        const totalDraws = OPENING_HAND + extra;
        const maxSuccesses = Math.min(K, totalDraws);

        // X-axis: number of successes (0 to maxSuccesses)
        const labels = Array.from({ length: maxSuccesses + 1 }, (_, i) => i);

        // PMF: P(X = k) for total draws only
        const pmfTotal = labels.map((k) => hypergeometricPmf(DECK_SIZE, K, totalDraws, k));

        // Cumulative: P(X >= k) for total draws
        const cumulativeTotal = labels.map((k) => {
          let sum = 0;
          for (let i = k; i <= maxSuccesses; i++) {
            sum += hypergeometricPmf(DECK_SIZE, K, totalDraws, i);
          }
          return sum;
        });

        // Update "at least one" display
        const atLeast1Pct = cumulativeTotal[1] * 100; // P(X >= 1)
        elements.atLeastOne.textContent = `${atLeast1Pct.toFixed(2)}%`;

        // ----- Combined Chart -----
        if (chart) chart.destroy();
        chart = new Chart(elements.ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                type: "bar",
                label: `P(exactly k targets in ${totalDraws} cards)`,
                data: pmfTotal,
                backgroundColor: chartColors.secondaryAlpha,
                borderColor: chartColors.secondary,
                borderWidth: 1,
                order: 2,
              },
              {
                type: "line",
                label: `P(at least k targets in ${totalDraws} cards)`,
                data: cumulativeTotal,
                borderColor: chartColors.success,
                backgroundColor: "transparent",
                tension: 0.2,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: chartColors.success,
                order: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              datalabels: {
                display: (context) => context.dataset.type === "bar",
                anchor: "end",
                align: "end",
                formatter: (value) => `${(value * 100).toFixed(0)}%`,
                font: { size: 11, weight: "bold" },
                color: chartColors.secondary,
              },
              tooltip: {
                filter: (context) => context.dataset.type === "line",
                displayColors: false,
                callbacks: {
                  title: () => "",
                  label: (context) => {
                    const pct = (context.raw * 100).toFixed(1);
                    const k = context.label;
                    return `${pct}% chance for at least ${k} targets`;
                  },
                },
              },
            },
            scales: {
              y: {
                title: { display: true, text: "Probability" },
                beginAtZero: true,
                max: 1,
                ticks: { callback: percentTickCallback },
              },
              x: {
                title: { display: true, text: "Cards" },
              },
            },
          },
        });
      }

      // ---------- Event Listeners ----------
      elements.sliderK.addEventListener("input", updateUI);
      elements.sliderExtra.addEventListener("input", updateUI);

      // ---------- Initialize ----------
      updateUI();
    })();
  </script>
</body>
</html>
